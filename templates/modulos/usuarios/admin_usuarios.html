{% include '/modulos/clientes/admin_header.html' %}

<div class="container py-5">
  <h1 class="mb-4 fw-bold text-primary">Administración de Usuarios</h1>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{ messages[0] }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
      </div>
    {% endif %}
  {% endwith %}

  <div class="d-flex justify-content-between align-items-center mb-3">
    <button class="btn btn-primary shadow-sm" data-bs-toggle="modal" data-bs-target="#userModal">
      <i class="bi bi-plus-lg me-1"></i> Nuevo Usuario
    </button>
    <input type="search" id="searchUser" class="form-control w-25" placeholder="Buscar usuario...">
  </div>

  <div class="table-responsive shadow-sm rounded">
    <table class="table table-striped table-hover align-middle mb-0">
      <thead class="table-primary">
        <tr>
          <th>ID</th>
          <th>Usuario</th>
          <th>Correo</th>
          <th>Nombre Completo</th>
          <th>Rol</th>
          <th>Teléfono</th>
          <th>Activo</th>
          <th class="text-center">Acciones</th>
        </tr>
      </thead>
      <tbody id="userTableBody">
        {% for u in usuarios %}
          <tr>
            <td>{{ u.id }}</td>
            <td>{{ u.username }}</td>
            <td>{{ u.correo }}</td>
            <td>{{ u.nombre }} {{ u.apellido }}</td>
            <td class="text-capitalize">{{ u.rol.replace('_', ' ') }}</td>
            <td>{{ u.telefono or '-' }}</td>
            <td>
              {% if u.activo %}
                <span class="badge bg-success">Sí</span>
              {% else %}
                <span class="badge bg-secondary">No</span>
              {% endif %}
            </td>
            <td class="text-center">
              <button class="btn btn-sm btn-outline-warning me-1"
                      onclick="openEditModal({{ u.id }}, '{{ u.username }}', '{{ u.correo }}', '{{ u.nombre }}', '{{ u.apellido }}', '{{ u.telefono }}', '{{ u.rol }}', {{ 1 if u.activo else 0 }})"
                      title="Editar usuario">
                <i class="bi bi-pencil-fill"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteUserModal"
                      data-user-id="{{ u.id }}" data-user-name="{{ u.username }}" title="Eliminar usuario">
                <i class="bi bi-trash-fill"></i>
              </button>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal Nuevo Usuario -->
<div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form method="post" action="{{ url_for('crear_usuario') }}" class="modal-content shadow">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="userModalLabel">Nuevo Usuario</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <input name="username" class="form-control mb-3" placeholder="Usuario" required>
        <input name="correo" type="email" class="form-control mb-3" placeholder="Correo" required>
        <input name="password" type="password" class="form-control mb-3" placeholder="Contraseña" required>
        <div class="row g-2">
          <div class="col-md-6">
            <input name="nombre" class="form-control" placeholder="Nombre">
          </div>
          <div class="col-md-6">
            <input name="apellido" class="form-control" placeholder="Apellido">
          </div>
        </div>
        <input name="telefono" class="form-control mt-3 mb-3" placeholder="Teléfono">
        <select name="rol" class="form-select mb-3" required>
          <option value="" disabled selected>Seleccione un rol</option>
          <option value="administrador">Administrador</option>
          <option value="personal_salud">Personal Salud</option>
          <option value="cuidador">Cuidador</option>
          <option value="familiar">Familiar</option>
        </select>
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" name="activo" id="activoNuevo" checked>
          <label class="form-check-label" for="activoNuevo">Activo</label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary fw-bold">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Editar Usuario -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form method="post" id="editUserForm" class="modal-content shadow">
      <div class="modal-header bg-warning">
        <h5 class="modal-title" id="editUserModalLabel">Editar Usuario</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="id" id="editUserId">
        <input name="username" id="editUsername" class="form-control mb-3" placeholder="Usuario" required>
        <input name="correo" id="editCorreo" type="email" class="form-control mb-3" placeholder="Correo" required>
        <input name="password" id="editPassword" type="password" class="form-control mb-3" placeholder="Contraseña (dejar vacío para no cambiar)">
        <div class="row g-2">
          <div class="col-md-6">
            <input name="nombre" id="editNombre" class="form-control" placeholder="Nombre">
          </div>
          <div class="col-md-6">
            <input name="apellido" id="editApellido" class="form-control" placeholder="Apellido">
          </div>
        </div>
        <input name="telefono" id="editTelefono" class="form-control mt-3 mb-3" placeholder="Teléfono">
        <select name="rol" id="editRol" class="form-select mb-3" required>
          <option value="" disabled>Seleccione un rol</option>
          <option value="administrador">Administrador</option>
          <option value="personal_salud">Personal Salud</option>
          <option value="cuidador">Cuidador</option>
          <option value="familiar">Familiar</option>
        </select>
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" name="activo" id="editActivo">
          <label class="form-check-label" for="editActivo">Activo</label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-warning fw-bold">Guardar cambios</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Eliminar Usuario -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form method="POST" id="deleteUserForm" class="modal-content shadow">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteUserModalLabel">Confirmar Eliminación</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <p>¿Estás seguro que deseas eliminar al usuario <strong id="deleteUserName"></strong>? Esta acción no se puede deshacer.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-danger fw-bold">Eliminar</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Bootstrap Icons CDN para iconos -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<script>
  function openEditModal(id, username, correo, nombre, apellido, telefono, rol, activo) {
    const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
    document.getElementById('editUserId').value = id;
    document.getElementById('editUsername').value = username;
    document.getElementById('editCorreo').value = correo;
    document.getElementById('editPassword').value = '';
    document.getElementById('editNombre').value = nombre;
    document.getElementById('editApellido').value = apellido;
    document.getElementById('editTelefono').value = telefono;
    document.getElementById('editRol').value = rol;
    document.getElementById('editActivo').checked = activo === 1;

    document.getElementById('editUserForm').action = `/admin/usuarios/editar/${id}`;

    modal.show();
  }

  // Modal eliminar usuario: cargar datos dinámicamente
  var deleteUserModal = document.getElementById('deleteUserModal');
  deleteUserModal.addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget;
    var userId = button.getAttribute('data-user-id');
    var userName = button.getAttribute('data-user-name');

    var userNameSpan = deleteUserModal.querySelector('#deleteUserName');
    userNameSpan.textContent = userName;

    var form = deleteUserModal.querySelector('#deleteUserForm');
    form.action = `/admin/usuarios/eliminar/${userId}`;
  });

  // Opcional: filtro búsqueda simple (puedes mejorar)
  document.getElementById('searchUser').addEventListener('input', function() {
    const filter = this.value.toLowerCase();
    const rows = document.querySelectorAll('#userTableBody tr');
    rows.forEach(row => {
      const username = row.children[1].textContent.toLowerCase();
      const fullname = row.children[3].textContent.toLowerCase();
      if (username.includes(filter) || fullname.includes(filter)) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  });
</script>

{% include 'footer.html' %}

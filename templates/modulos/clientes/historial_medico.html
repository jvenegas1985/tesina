{% include '/modulos/clientes/admin_header.html' %}

<div class="container mt-1 pt-4">
<h5 class="mb-4 text-center">Historial M√©dico de {{ residente.nombre_completo | e }}</h5>



  <a href="/ver_info/{{ residente_id }}" class="btn btn-sm btn-outline-secondary mb-3">
    <i class="fas fa-arrow-left"></i> Regresar
  </a>

  <div id="alertaExito" class="alert alert-success d-none text-center" role="alert">
    Registro eliminado correctamente.
  </div>

  <div class="row">
    <!-- Historial M√©dico -->
    <div class="col-md-12">
      <div class="card shadow-lg rounded-4 mb-4">
        <div class="card-body">
          <h6 class="card-title text-primary">Historial M√©dico</h6>
          <p class="text-muted">Registros m√©dicos del residente.</p>

          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead class="table-light">
                <tr>
                  <th>Fecha</th>
                  <th>Diagn√≥stico</th>
                  <th>Observaciones</th>
                  <th class="text-center">Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for registro in historial %}
                <tr>
                  <td>{{ registro.fecha.strftime('%d/%m/%Y') if registro.fecha else '' }}</td>

                  <td>{{ registro.diagnostico | e }}</td>
                  <td>{{ registro.observaciones | e }}</td>
                  <td class="text-center">
                    <button 
  type="button" 
  class="btn btn-sm btn-outline-warning btn-editar" 
  data-id="{{ registro.id }}"
  data-fecha="{{ registro.fecha.strftime('%Y-%m-%d') if registro.fecha else '' }}"
  data-diagnostico="{{ registro.diagnostico | e }}"
  data-observaciones="{{ registro.observaciones | e }}"
  data-bs-toggle="modal" 
  data-bs-target="#modalEditarRegistro"
  title="Editar"
>‚úèÔ∏è</button>

                    <button type="button" class="btn btn-sm btn-outline-danger btn-eliminar" data-id="{{ registro.id }}" data-bs-toggle="modal" data-bs-target="#modalConfirmarEliminar" title="Eliminar">üóëÔ∏è</button>
                  </td>
                </tr>
                {% else %}
                <tr><td colspan="4" class="text-center">No hay registros.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="text-center mt-3">
            <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#modalAgregarRegistro">
              ‚ûï Agregar Registro M√©dico
            </button>
          </div>
        </div>
      </div>
    </div>

    
<!-- Modal Agregar Registro -->
<div class="modal fade" id="modalAgregarRegistro" tabindex="-1" aria-labelledby="modalAgregarRegistroLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="formAgregarRegistro" method="POST" action="/historial_medico/{{ residente_id }}/nuevo">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalAgregarRegistroLabel">Agregar Registro M√©dico</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="fecha" class="form-label">Fecha</label>
            <input type="date" class="form-control" id="fecha" name="fecha" required>
          </div>
          <div class="mb-3">
            <label for="diagnostico" class="form-label">Diagn√≥stico</label>
            <textarea class="form-control" id="diagnostico" name="diagnostico" rows="3" required></textarea>
          </div>
          <div class="mb-3">
            <label for="observaciones" class="form-label">Observaciones</label>
            <textarea class="form-control" id="observaciones" name="observaciones" rows="3"></textarea>
          </div>
          <div id="mensajeError" class="text-danger d-none"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </div>
    </form>
  </div>
</div>
<!-- Modal Editar Registro -->
<div class="modal fade" id="modalEditarRegistro" tabindex="-1" aria-labelledby="modalEditarRegistroLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="formEditarRegistro" method="POST">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalEditarRegistroLabel">Editar Registro M√©dico</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editarId" name="id" value="">
          <div class="mb-3">
            <label for="editarFecha" class="form-label">Fecha</label>
            <input type="date" class="form-control" id="editarFecha" name="fecha" required>
          </div>
          <div class="mb-3">
            <label for="editarDiagnostico" class="form-label">Diagn√≥stico</label>
            <textarea class="form-control" id="editarDiagnostico" name="diagnostico" rows="3" required></textarea>
          </div>
          <div class="mb-3">
            <label for="editarObservaciones" class="form-label">Observaciones</label>
            <textarea class="form-control" id="editarObservaciones" name="observaciones" rows="3"></textarea>
          </div>
          <div id="mensajeErrorEditar" class="text-danger d-none"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Modal Confirmar Eliminaci√≥n -->
<div class="modal fade" id="modalConfirmarEliminar" tabindex="-1" aria-labelledby="modalConfirmarEliminarLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalConfirmarEliminarLabel">Confirmar Eliminaci√≥n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        ¬øEst√°s seguro que quieres eliminar este registro?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" id="btnEliminarConfirmar">Eliminar</button>
      </div>
    </div>
  </div>
</div>

<script>
  function obtenerFechaHoy() {
    const hoy = new Date();
    return `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}-${String(hoy.getDate()).padStart(2, '0')}`;
  }

  document.getElementById('modalAgregarRegistro').addEventListener('show.bs.modal', () => {
    document.getElementById('fecha').value = obtenerFechaHoy();
  });

  document.getElementById('formAgregarRegistro').addEventListener('submit', function (event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const mensajeError = document.getElementById('mensajeError');
    location.reload()

    fetch(form.action, {
      method: 'POST',
      body: formData,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        mensajeError.textContent = data.error;
        mensajeError.classList.remove('d-none');
      } else {
        mensajeError.classList.add('d-none');
        // Ocultar modal correctamente
        const modalAgregar = bootstrap.Modal.getInstance(document.getElementById('modalAgregarRegistro'));
        modalAgregar.hide();
        location.reload()

        // Limpiar backdrop si queda pegado
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        document.body.classList.remove('modal-open');
        document.body.style = '';

        location.reload()

        const tbody = document.querySelector('table.table tbody');
        const nuevoRegistro = document.createElement('tr');
        nuevoRegistro.innerHTML = `
          <td>${data.fecha}</td>
          <td>${data.diagnostico}</td>
          <td>${data.observaciones}</td>
          <td class="text-center">
            <a href="/historial_medico/${data.id}/editar" class="btn btn-sm btn-outline-warning">‚úèÔ∏è</a>
            <button class="btn btn-sm btn-outline-danger btn-eliminar" data-id="${data.id}" data-bs-toggle="modal" data-bs-target="#modalConfirmarEliminar">üóëÔ∏è</button>
          </td>`;
        const sinRegistros = tbody.querySelector('td[colspan]');
        if (sinRegistros) sinRegistros.parentElement.remove();
        tbody.appendChild(nuevoRegistro);
      }
    })
    .catch(() => {
      mensajeError.textContent = 'Error al guardar el registro.';
      mensajeError.classList.remove('d-none');
    });
  });

  document.addEventListener('DOMContentLoaded', () => {
    let idAEliminar = null;
    let filaAEliminar = null;
    const modalEliminar = document.getElementById('modalConfirmarEliminar');
    const alertaExito = document.getElementById('alertaExito');

    modalEliminar.addEventListener('show.bs.modal', (event) => {
      const btn = event.relatedTarget;
      idAEliminar = btn.getAttribute('data-id');
      filaAEliminar = btn.closest('tr');
    });

    document.getElementById('btnEliminarConfirmar').addEventListener('click', () => {
      if (!idAEliminar) return;

      fetch(`/historial_medico/${idAEliminar}/eliminar`, {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          const modal = bootstrap.Modal.getInstance(modalEliminar);
          modal.hide();

          modalEliminar.addEventListener('hidden.bs.modal', function onHidden() {
            if (filaAEliminar) filaAEliminar.remove();
            alertaExito.classList.remove('d-none');
            setTimeout(() => alertaExito.classList.add('d-none'), 3000);

            // Limpiar backdrop despu√©s de cerrar modal eliminar
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            document.body.classList.remove('modal-open');
            document.body.style = '';

            modalEliminar.removeEventListener('hidden.bs.modal', onHidden);
          });
        } else {
          alert('Error al eliminar: ' + (data.error || 'Error desconocido'));
        }
      })
      .catch(() => alert('Error en la comunicaci√≥n con el servidor.'));
    });
  });

  document.querySelectorAll('.btn-editar').forEach(btn => {
  btn.addEventListener('click', () => {
    document.getElementById('editarId').value = btn.dataset.id;
    document.getElementById('editarFecha').value = btn.dataset.fecha;
    document.getElementById('editarDiagnostico').value = btn.dataset.diagnostico;
    document.getElementById('editarObservaciones').value = btn.dataset.observaciones;
    
    document.getElementById('formEditarRegistro').action = `/historial_medico/${btn.dataset.id}/editar`;
  });
});

document.getElementById('formEditarRegistro').addEventListener('submit', function(event) {
  event.preventDefault();
  const form = event.target;
  const formData = new FormData(form);
  const mensajeError = document.getElementById('mensajeErrorEditar');

  fetch(form.action, {
    method: 'POST',
    body: formData,
    headers: { 'X-Requested-With': 'XMLHttpRequest' }
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      mensajeError.textContent = data.error;
      mensajeError.classList.remove('d-none');
    } else {
      mensajeError.classList.add('d-none');
      const modal = bootstrap.Modal.getInstance(document.getElementById('modalEditarRegistro'));
      modal.hide();

      // Actualizar la fila de la tabla
      const fila = document.querySelector(`button[data-id="${data.id}"]`).closest('tr');
      fila.innerHTML = `
        <td>${data.fecha}</td>
        <td>${data.diagnostico}</td>
        <td>${data.observaciones}</td>
        <td class="text-center">
          <button 
            type="button" 
            class="btn btn-sm btn-outline-warning btn-editar" 
            data-id="${data.id}"
            data-fecha="${data.fechaISO}"
            data-diagnostico="${data.diagnostico}"
            data-observaciones="${data.observaciones}"
            data-bs-toggle="modal" 
            data-bs-target="#modalEditarRegistro"
            title="Editar"
          >‚úèÔ∏è</button>
          <button class="btn btn-sm btn-outline-danger btn-eliminar" data-id="${data.id}" data-bs-toggle="modal" data-bs-target="#modalConfirmarEliminar">üóëÔ∏è</button>
        </td>
      `;

      // Reasignar el listener al nuevo bot√≥n editar
      fila.querySelector('.btn-editar').addEventListener('click', () => {
        document.getElementById('editarId').value = data.id;
        document.getElementById('editarFecha').value = data.fechaISO;
        document.getElementById('editarDiagnostico').value = data.diagnostico;
        document.getElementById('editarObservaciones').value = data.observaciones;
        document.getElementById('formEditarRegistro').action = `/historial_medico/${data.id}/editar`;
      });
    }
  })
  .catch(() => {
    mensajeError.textContent = 'Error al actualizar el registro.';
    mensajeError.classList.remove('d-none');
  });
});

  
</script>

{% include 'footer.html' %}
